import { b as etemplate2, a7 as et2_dialog, g as et2_nextmatch } from '../../chunks/etemplate2-72472c12.js';
import '../../chunks/egw_json-c3ebf946.js';
import '../../vendor/bower-asset/jquery/dist/jquery.min.js';
import '../../vendor/bower-asset/cropper/dist/cropper.min.js';
import '../../vendor/bower-asset/diff2html/dist/diff2html.min.js';
import '../../vendor/tinymce/tinymce/tinymce.min.js';

/**
 * EGroupware Schulmanager
 *
 * @link http://www.egroupware.org
 * @package schulmanager
 * @author Axel Wild <info-AT-wild-solutions.de>
 * @copyright (c) 2022 by info-AT-wild-solutions.de
 * @license http://opensource.org/licenses/gpl-license.php GPL - GNU General Public License
 */
class SchulmanagerApp extends EgwApp {
  appname = 'schulmanager';

  constructor() {
    super('schulmanager');
  }
  /**
   * This function is called when the etemplate2 object is loaded
   * and ready.  If you must store a reference to the et2 object,
   * make sure to clean it up in destroy().
   *
   * @param et2 etemplate2 Newly ready object
   * @param string name
   */


  et2_ready(et2, name) {
    // call parent
    super.et2_ready(et2, name);

    if (name == 'schulmanager.notenmanager.index') {
      this.header_change();
    }

    if (name == 'schulmanager.notenmanager.edit') {
      this.header_change();
    }

    if (name == 'schulmanager.calendar.index') {
      this.cal_header_change();
      this.cal_hide_items();
    }

    if (name == 'schulmanager.notenmanager.notendetails') {
      this.header_change();
    }

    if (name == 'schulmanager.schuelerview') {
      this.onSchuelerViewKlasseChanged();
    }
  }
  /**
   * laden der gewichtungen beim ersten Laden des Templates
   * @param {type} _action
   * @returns {undefined}
   */


  header_change() {
    let et2 = this.et2;
    let func = 'schulmanager.schulmanager_ui.ajax_getGewichtungen';
    let query = '';
    this.egw.json(func, [query], function (totals) {
      for (let key in totals) {
        let widget = et2.getWidgetById(key);

        if (widget) {
          widget.set_value(totals[key]);
        }
      }
    }).sendRequest(true);
  } // export notenbuch


  exportpdf_nb(_id, _widget) {
    this.egw.loading_prompt('schulmanager', true, this.egw.lang('please wait...'));
    let $a = jQuery(document.createElement('a')).appendTo('body').hide();
    let url = window.egw.webserverUrl + '/index.php?menuaction=schulmanager.schulmanager_download_ui.exportpdf_nb';
    $a.prop('href', url);
    $a.prop('download', '');
    $a[0].click();
    $a.remove();
    this.egw.loading_prompt('schulmanager', false);
  }
  /**
   * download all grades in all subjects of all students as pdf
   * @param {type} _id
   * @param {type} _widget
   * @returns {undefined}
   */


  exportpdf_kv(_id, _widget) {
    let id = _widget.id;
    let params = 'mode=stud';

    if (id == "button[pdfexportteacherzz]") {
      params = 'mode=teacher_zz';
    } else if (id == "button[pdfexportteacherjz]") {
      params = 'mode=teacher_jz';
    }

    let modal = document.getElementById("schulmanager-notenmanager-klassenview_showexportmodal");
    modal.style.display = "none";
    this.egw.loading_prompt('schulmanager', true, egw.lang('please wait...'));
    let $a = jQuery(document.createElement('a')).appendTo('body').hide();
    let url = window.egw.webserverUrl + '/index.php?menuaction=schulmanager.schulmanager_download_ui.exportpdf_kv&' + params;
    $a.prop('href', url);
    $a.prop('download', '');
    $a[0].click();
    $a.remove();
    egw.loading_prompt('schulmanager', false);
  }
  /**
   * reload klassleiter before pdf export
   * @param _id
   * @param _widget
   */


  exportpdf_nbericht_prepare(_id, _widget) {
    let modal = document.getElementById("schulmanager-notenmanager-klassenview_showexportmodal");
    modal.style.display = "block";
    let func = 'schulmanager.schulmanager_ui.ajax_nbericht_prepare';
    this.egw.json(func, [], function (result) {
      let widget = document.getElementById('schulmanager-notenmanager-klassenview_klassleiter');

      if (widget) {
        let length = widget.options.length;

        for (let i = length - 1; i >= 0; i--) {
          widget.options[i] = null;
        }

        for (let key in result['klassleiter']) {
          let opt = document.createElement("option");
          opt.value = key;
          opt.text = result['klassleiter'][key];
          widget.options.add(opt);
        }
      }
    }).sendRequest(true);
  }
  /**
   * download all grades in all subjects of all students as pdf handout for students
   * @param {type} _id
   * @param {type} _widget
   * @returns {undefined}
   */


  exportpdf_nbericht(_id, _widget) {
    let modal = document.getElementById("schulmanager-notenmanager-klassenview_showexportmodal");
    modal.style.display = "none";
    this.egw.loading_prompt('schulmanager', true, this.egw.lang('please wait...'));
    let showReturn = document.getElementById('schulmanager-notenmanager-klassenview_add_return_block').checked;
    let showSigned = document.getElementById('schulmanager-notenmanager-klassenview_add_signed_block').checked;
    let signerWidget = document.getElementById('schulmanager-notenmanager-klassenview_klassleiter');
    let signerid = signerWidget.value;
    let $a = jQuery(document.createElement('a')).appendTo('body').hide();
    let url = window.egw.webserverUrl + '/index.php?menuaction=schulmanager.schulmanager_download_ui.exportpdf_nbericht&showReturnInfo=' + showReturn + '&signed=' + showSigned + '&signerid=' + signerid;
    $a.prop('href', url);
    $a.prop('download', '');
    $a[0].click();
    $a.remove();
    this.egw.loading_prompt('schulmanager', false);
  }
  /**
   * export notenbuch
   * @param _id
   * @param _widget
   */


  exportpdf_calm(_id, _widget) {
    let egw = this.egw;
    egw.loading_prompt('schulmanager', true, egw.lang('please wait...'));
    let $a = jQuery(document.createElement('a')).appendTo('body').hide();
    let url = window.egw.webserverUrl + '/index.php?menuaction=schulmanager.schulmanager_download_ui.exportpdf_calm';
    $a.prop('href', url);
    $a.prop('download', '');
    $a[0].click();
    $a.remove();
    this.egw.loading_prompt('schulmanager', false);
  }
  /**
   * laden der weekdays
   * @param {type} _action
   * @returns {undefined}
   */


  cal_header_change() {
    let et2 = this.et2;
    let func = 'schulmanager.schulmanager_cal_ui.ajax_getWeekdays';
    let query = '';
    this.egw.json(func, [query], function (result) {
      for (let key in result['nm_header']) {
        let widget = et2.getWidgetById(key);

        if (widget) {
          widget.getDOMNode().childNodes[0].innerHTML = result['nm_header'][key]['nr'];
          widget.getDOMNode().childNodes[1].innerHTML = result['nm_header'][key]['name'];
          widget.parentNode.parentNode.classList.remove('sm_cal_saso');
          widget.parentNode.parentNode.classList.remove('sm_cal_mofr');
          widget.parentNode.parentNode.classList.add(result['nm_header'][key]['class']);

          if (result['nm_header'][key]['class'] == 'sm_cal_saso' && widget.getDOMNode().childNodes[2]) {
            widget.getDOMNode().childNodes[2].style.display = "none";
          }
        }
      }
    }).sendRequest(true);
  }

  cal_hide_items() {
    egw.css(".sm_cal_hidden", "display:none");
  }

  cal_focus_item(_action, widget) {
    //alert(widget.getDOMNode());
    let _send = function () {
      egw().json('schulmanager.schulmanager_cal_ui.ajax_editCalEvent', [widget.id], // Remove loading spinner
      function (result) {
        jQuery(_action).blur(); //alert(result['test']);
      }).sendRequest(true);
    };

    _send();
  }

  calEditMultiple(_action, widget) {
    //alert(widget.id);
    let _send = function () {
      egw().json('schulmanager.schulmanager_cal_ui.ajax_editCalEvent', [widget.id, true], // Remove loading spinner
      function (result) {
        jQuery(_action).blur(); //alert(result['test']);
      }).sendRequest(true);
    };

    _send();
  }

  calDeleteEvent(_action, widget) {
    //alert(widget[0].id);
    let _send = function () {
      egw().json('schulmanager.schulmanager_cal_ui.ajax_deleteEvent', [widget[0].id], // Remove loading spinner
      function (result) {
        egw(window).refresh(result['msg'], 'schulmanager', 'schulmanager-calendar-editevent', 'update');
        var nm = etemplate2.getById('schulmanager-calendar-editevent').widgetContainer.getWidgetById('nm');
        nm.refresh(null, 'update');
      }).sendRequest(true);
    };

    _send();
  }

  add_list_event(widget, prefix) {
    let et2 = this.et2;
    let type_id = prefix.concat('sm_type_options_list');
    let fach_id = prefix.concat('sm_fach_options_list');
    let user_id = prefix.concat('sm_user_list');
    let type = document.getElementById(type_id).value;
    let fach = document.getElementById(fach_id).value;
    let user = null;

    if (document.getElementById(user_id)) {
      user = document.getElementById(user_id).value;
    } else {
      user_id = prefix.concat('sm_activeuserID');
      user = document.getElementById(user_id).value;
    }

    let _send = function () {
      egw().json('schulmanager.schulmanager_cal_ui.ajax_addEventToList', [type, fach, user], // Remove loading spinner
      function (result) {
        egw(window).refresh(result['msg'], 'schulmanager', 'schulmanager-calendar-editevent', 'update');
        let nm = etemplate2.getById('schulmanager-calendar-editevent').widgetContainer.getWidgetById('nm');
        nm.refresh(null, 'update');
      }).sendRequest(true);
    };

    _send();
  }

  calShowAddEvent(action, selected) {
    jQuery('table.addnewevent').css('display', 'inline');
  }

  nmEditGew(_action, widget) {
    jQuery('table.editgew').css('display', 'inline');
  }

  changeNote(action, _senders) {
    let tokenDiv = document.getElementById('schulmanager-notenmanager-edit_token');
    let inputinfo_date = document.getElementById('schulmanager-notenmanager-edit_date').firstChild;
    let inputinfo_type = document.getElementById('schulmanager-notenmanager-edit_notgebart');
    let inputinfo_desc = document.getElementById('schulmanager-notenmanager-edit_desc');
    let func = 'schulmanager.schulmanager_ui.ajax_noteModified';
    let noteKey = action.name;
    let noteVal = action.value;
    let token = tokenDiv.value;
    let note_date = inputinfo_date.value;
    let note_type = inputinfo_type.value;
    let note_desc = inputinfo_desc.value;

    if (action.type == "checkbox") {
      if (action.checked) {
        noteVal = 1;
      } else {
        noteVal = 0;
      }
    }

    this.egw.json(func, [noteKey, noteVal, token, note_date, note_type, note_desc], function (result) {
      jQuery(action).addClass('schulmanager_note_changed');

      for (let key in result) {
        if (key == 'error_msg') {
          alert("Error:\n\t" + result[key]);
          break;
        }

        let cssAvgKey = 'schulmanager-notenmanager-edit_' + key + '[-1][note]';
        let widget = document.getElementById(cssAvgKey);

        if (widget) {
          widget.value = result[key]['[-1][note]'];

          if (action.id == cssAvgKey) {
            // reset css class if this input value has been modified
            jQuery(action).removeClass('nm_avg_manuell');
            jQuery(action).removeClass('nm_avg_auto');
            jQuery(action).addClass(result[key]['avgclass']);
          }
        }
      }
    }).sendRequest(true);
  }

  changeGew(action, senders) {
    let et2 = this.et2;
    let func = 'schulmanager.schulmanager_ui.ajax_gewModified';
    let gewKey = action.name;
    let gewVal = action.value;
    this.egw.json(func, [gewKey, gewVal], function (result) {
      jQuery(action).addClass('schulmanager_note_changed');

      for (let key in result) {
        let cssAvgKey = 'schulmanager-notenmanager-edit_' + key + '[-1][note]';
        let widget = document.getElementById(cssAvgKey);

        if (widget) {
          widget.value = result[key]['[-1][note]'];
        }
      }
    }).sendRequest(true);
  }

  changeGewAllModified(_action, _senders) {
    let et2 = this.et2;
    let func = 'schulmanager.schulmanager_ui.ajax_gewAllModified';
    let noteKey = _action.name;
    let noteVal = _action.value;

    if (_action.type == "checkbox") {
      if (_action.checked) {
        noteVal = 1;
      } else {
        noteVal = 0;
      }
    }

    this.egw.json(func, [noteKey, noteVal], function (result) {
      jQuery(_action).addClass('schulmanager_note_changed');

      for (let key in result) {
        let cssAvgKey = 'schulmanager-notenmanager-edit_' + key + '[-1][note]';
        let cssAltBKey = 'schulmanager-notenmanager-edit_' + key + '[-1][checked]';
        let widget = document.getElementById(cssAvgKey);
        let widgetAltB = document.getElementById(cssAltBKey);

        if (widget) {
          widget.value = result[key]['[-1][note]'];

          if (_action.id == cssAvgKey) {
            jQuery(_action).removeClass('nm_avg_manuell');
            jQuery(_action).removeClass('nm_avg_auto');
            jQuery(_action).addClass(result[key]['avgclass']);
          }
        } else if (widgetAltB) {
          widgetAltB.checked = result[key]['[-1][checked]'];
        }
      }
    }).sendRequest(true);
  }
  /**
   * selectes teacher for a new substitution changed, reload list
   */


  subs_TeacherChanged(_action, _senders) {
    let et2 = this.et2;
    let func = 'schulmanager.schulmanager_substitution_ui.ajax_getTeacherLessonList';
    let teacher_id = _action.value;
    this.egw.json(func, [teacher_id], function (result) {
      let widget = document.getElementById('schulmanager-substitution_add_lesson_list');

      if (widget) {
        let length = widget.options.length;

        for (let i = length - 1; i >= 0; i--) {
          widget.options[i] = null;
        }

        for (let key in result) {
          let opt = document.createElement("option");
          opt.value = key;
          opt.text = result[key];
          widget.options.add(opt);
        }
      }
    }).sendRequest(true);
  }
  /**
   * AJAX loading student
   * @param _action
   * @param _senders
   */


  onDetailsNote(_action, _senders) {
    let modal = document.getElementById("schulmanager-notenmanager-index_showdetailsmodal");
    modal.style.display = "block";
    let instance = this;
    let stud_id = _senders[0]._index;
    let func = 'schulmanager.schulmanager_ui.ajax_getStudentDetails';
    this.egw.json(func, [stud_id], function (result) {
      let modal = document.getElementById("schulmanager-notenmanager-index");
      modal.style.display = "block";

      for (let key in result) {
        // noten
        if (key == 'details_noten') {
          instance.updateDetailsNoten(key, result, 'schulmanager-notenmanager-index_');
        } else {
          let widget_id = 'schulmanager-notenmanager-index_' + key;
          let widget = document.getElementById(widget_id);

          if (widget) {
            widget.innerText = result[key];
          }
        }
      }

      jQuery('#schulmanager-notenmanager-index_schulmanager-notenmanager-details').css('display', 'inline');
    }).sendRequest(true);
  }
  /**
   * AJAX loading student
   * @param _action
   * @param _senders
   */


  onContactData(_action, _senders) {
    let modal = document.getElementById("schulmanager-notenmanager-index_showcontactmodal");
    modal.style.display = "block";
    let instance = this;
    let stud_id = _senders[0]._index;
    let func = 'schulmanager.schulmanager_ui.ajax_getStudentContact';
    this.egw.json(func, [stud_id], function (result) {
      let modal = document.getElementById("schulmanager-notenmanager-index");
      modal.style.display = "block";
      instance.tableUpdate("schulmanager-notenmanager-index_grid-sko", result['sko_nm_rows']);
      instance.tableUpdate("schulmanager-notenmanager-index_grid-san", result['san_nm_rows']);
      delete result['sko_nm_rows'];
      delete result['san_nm_rows'];

      for (let key in result) {
        let widget_id = 'schulmanager-notenmanager-index_' + key;
        let widget = document.getElementById(widget_id);

        if (widget) {
          widget.innerText = result[key];
        }
      }

      jQuery('#schulmanager-notenmanager-index_schulmanager-contact').css('display', 'inline');
    }).sendRequest(true);
  }
  /**
   * select students for a new class changed, reload list
   */


  onDetailsKlasseChanged(_action, _senders) {
    let instance = this;
    let egw = this.egw;
    this.egw.loading_prompt('schulmanager', true, egw.lang('please wait...'));
    let et2 = this.et2;
    let func = 'schulmanager.schulmanager_ui.ajax_DetailsKlasseChanged';
    let klasse_id = _action.value;
    this.egw.json(func, [klasse_id], function (result) {
      // update schueler select
      let widget = document.getElementById('schulmanager-notenmanager-notendetails_select_schueler');

      if (widget) {
        let length = widget.options.length;

        for (let i = length - 1; i >= 0; i--) {
          widget.options[i] = null;
        }

        for (let key in result['select_schueler']) {
          let opt = document.createElement("option");
          opt.value = key;
          opt.text = result['select_schueler'][key];
          widget.options.add(opt);
        }
      }

      delete result['select_schueler'];

      for (let key in result) {
        if (key == 'details_noten') {
          instance.updateDetailsNoten(key, result, 'schulmanager-notenmanager-notendetails_');
        } else {
          let widgetItem = document.getElementById('schulmanager-notenmanager-notendetails_' + key);

          if (widgetItem) {
            widgetItem.innerText = result[key];
          }
        }
      }

      egw.loading_prompt('schulmanager', false);
    }).sendRequest(true);
  }
  /**
   * selectes teacher for a new substitution changed, reload list
   */


  onDetailsSchuelerChanged(_action, _senders) {
    let instance = this; //this.egw.loading_prompt('schulmanager',true,egw.lang('please wait...'));

    let et2 = this.et2;
    let func = 'schulmanager.schulmanager_ui.ajax_DetailsSchuelerChanged';
    let schueler_id = _action.value;
    this.egw.json(func, [schueler_id], function (result) {
      for (let key in result) {
        if (key == 'details_noten') {
          instance.updateDetailsNoten(key, result, 'schulmanager-notenmanager-notendetails_');
        } else {
          let widgetItem = document.getElementById('schulmanager-notenmanager-notendetails_' + key);

          if (widgetItem) {
            widgetItem.innerText = result[key];
          } else {//alert(key);
          }
        }
      } //egw.loading_prompt('schulmanager',false);

    }).sendRequest(true);
  }
  /**
   * updates noten table in details view
   * @param key
   * @param result
   */


  updateDetailsNoten(key, result, id_prefix) {
    if (key == 'details_noten') {
      for (let block in result[key]) {
        for (let sIndex in result[key][block]) {
          let index = parseInt(sIndex);

          if (index >= -1 && index <= 11) {
            for (let col in result[key][block][index]) {
              let widget_col_id = id_prefix + key + '[' + block + ']' + '[' + index + ']' + '[' + col + ']';
              let widget_col = document.getElementById(widget_col_id);

              if (widget_col) {
                widget_col.innerText = result[key][block][index][col];
              }
            }
          }
        }
      }
    }
  }
  /**
   * selectes teacher for a new substitution changed, reload list
   */


  onDetailsNotenEdit(_action, _senders) {
    let idPostfix = _senders.id.substring(4);

    let isGlnw = _senders.id.substring(5, 9) == 'glnw';
    let modal = document.getElementById("schulmanager-notenmanager-notendetails_editcontentmodal");
    modal.style.display = "block";
    let widgetNote = document.getElementById('schulmanager-notenmanager-notendetails_details_noten' + idPostfix + '[note]');

    if (widgetNote) {
      let note_input = document.getElementById('schulmanager-notenmanager-notendetails_edit_note');
      note_input.value = widgetNote.innerText;
    } // select GLNW and KLNW


    let widgetTypeGKlnw = document.getElementById('schulmanager-notenmanager-notendetails_details_noten' + idPostfix + '[art]');

    if (widgetTypeGKlnw) {
      let selTypeGlnw = document.getElementById('schulmanager-notenmanager-notendetails_notgebart_glnw');
      let selTypeKlnw = document.getElementById('schulmanager-notenmanager-notendetails_notgebart_klnw');

      if (isGlnw) {
        for (let i = 0; i < selTypeGlnw.options.length; i++) {
          if (selTypeGlnw.options[i].innerText == widgetTypeGKlnw.innerText) {
            selTypeGlnw.options[i].selected = true;
            break;
          }
        }

        selTypeGlnw.style.display = "block";
        selTypeKlnw.options[0].selected = true;
        selTypeKlnw.style.display = "none"; // update style

        jQuery(".details-grid-edit tr:nth-child(even)").css("background", "#fff9ba");
        jQuery(".details-grid-edit tr:nth-child(odd)").css("background", "#fff47c");
        jQuery(".details-grid-edit td").css("border", "1px solid #ffdd00"); // end update style
      } else {
        for (let i = 0; i < selTypeKlnw.options.length; i++) {
          if (selTypeKlnw.options[i].innerText == widgetTypeGKlnw.innerText) {
            selTypeKlnw.options[i].selected = true;
            break;
          }
        }

        selTypeGlnw.options[0].selected = true;
        selTypeGlnw.style.display = "none";
        selTypeKlnw.style.display = "block"; // update style

        jQuery(".details-grid-edit tr:nth-child(even)").css("background", "#beeaac");
        jQuery(".details-grid-edit tr:nth-child(odd)").css("background", "#a1e684");
        jQuery(".details-grid-edit td").css("border", "1px solid #7ecc67"); // end update style
      }

      document.getElementById('schulmanager-notenmanager-notendetails_edit_type_flag').innerText = isGlnw ? "glnw" : "klnw";
    } // definition date


    let widgetDefDate = document.getElementById('schulmanager-notenmanager-notendetails_details_noten' + idPostfix + '[definition_date]');

    if (widgetDefDate) {
      let defDate_input = document.getElementById('schulmanager-notenmanager-notendetails_edit_date').firstChild;
      defDate_input.value = widgetDefDate.innerText;
    } // description


    let widgetDesc = document.getElementById('schulmanager-notenmanager-notendetails_details_noten' + idPostfix + '[description]');

    if (widgetDesc) {
      let desc_input = document.getElementById('schulmanager-notenmanager-notendetails_edit_desc');
      desc_input.value = widgetDesc.innerText;
    } // note kaay


    let note_key = document.getElementById('schulmanager-notenmanager-notendetails_edit_note_key');
    note_key.value = idPostfix;
  }
  /**
   * Commits edited noten value
   * @param _action
   * @param _senders
   */


  onDetailsNotenCommit(_action, _senders) {
    let egw = this.egw;
    let instance = this;
    this.egw.loading_prompt('schulmanager', true, egw.lang('please wait...')); // read data

    let noteElement = document.getElementById('schulmanager-notenmanager-notendetails_edit_note');
    let noteVal = noteElement.value;
    let typeFlagElement = document.getElementById('schulmanager-notenmanager-notendetails_edit_type_flag');
    let typeFlag = typeFlagElement.innerText;
    let note_type = 0;

    if (typeFlag == "glnw") {
      let selTypeGlnw = document.getElementById('schulmanager-notenmanager-notendetails_notgebart_glnw');
      note_type = selTypeGlnw.selectedIndex;
    } else if (typeFlag == "klnw") {
      let selTypeKlnw = document.getElementById('schulmanager-notenmanager-notendetails_notgebart_klnw');
      note_type = selTypeKlnw.selectedIndex;
    }

    let dateElement = document.getElementById('schulmanager-notenmanager-notendetails_edit_date').firstChild;
    let note_date = dateElement.value;
    let descElement = document.getElementById('schulmanager-notenmanager-notendetails_edit_desc');
    let note_desc = descElement.value;
    let tokenElement = document.getElementById('schulmanager-notenmanager-notendetails_token');
    let token = tokenElement.value;
    let noteKeyElement = document.getElementById('schulmanager-notenmanager-notendetails_edit_note_key');
    let noteKey = noteKeyElement.value; // send data

    let func = 'schulmanager.schulmanager_ui.ajax_noteDetailsModified';
    this.egw.json(func, [noteKey, noteVal, token, note_date, note_type, note_desc, typeFlag], function (result) {
      //alert("done");
      for (let key in result) {
        if (key == 'details_noten') {
          instance.updateDetailsNoten(key, result, 'schulmanager-notenmanager-notendetails_');
        } else {
          let widgetItem = document.getElementById('schulmanager-notenmanager-notendetails_' + key);

          if (widgetItem) {
            widgetItem.innerText = result[key];
          } else {//alert(key);
          }
        }
      }

      egw.loading_prompt('schulmanager', false);
    }).sendRequest(true); // hide div

    let modal = document.getElementById("schulmanager-notenmanager-notendetails_editcontentmodal");
    modal.style.display = "none";
  }

  onDetailsNotenCancel(_action, _senders) {
    let modal = document.getElementById("schulmanager-notenmanager-notendetails_editcontentmodal");
    modal.style.display = "none";
  }
  /**
   * Delete single
   * @param _action
   * @param _senders
   */


  onDetailsNotenDelete(_action, _senders) {
    let instance = this;
    let egw = this.egw;
    let tokenElement = document.getElementById('schulmanager-notenmanager-notendetails_token');
    let token = tokenElement.value;
    let noteKeyElement = document.getElementById('schulmanager-notenmanager-notendetails_edit_note_key');
    let noteKey = noteKeyElement.value; //var modal = document.getElementById("schulmanager-notenmanager-notendetails_editcontentmodal");
    //modal.style.display = "none";

    let action_id = _action.id;
    et2_dialog.show_dialog(function (button_id, value) {
      if (button_id != et2_dialog.NO_BUTTON) {
        let func = 'schulmanager.schulmanager_ui.ajax_noteDetailsDeleted';
        egw.json(func, [noteKey, token], function (result) {
          for (let key in result) {
            if (key == 'details_noten') {
              instance.updateDetailsNoten(key, result, 'schulmanager-notenmanager-notendetails_');
            } else {
              let widgetItem = document.getElementById('schulmanager-notenmanager-notendetails_' + key);

              if (widgetItem) {
                widgetItem.innerText = result[key];
              } else {}
            }
          }
        }).sendRequest(true);
      }
    }, egw.lang('Confirmation required'), egw.lang('Confirmation required'), {}, et2_dialog.BUTTONS_OK_CANCEL, et2_dialog.QUESTION_MESSAGE);
    let modal = document.getElementById("schulmanager-notenmanager-notendetails_editcontentmodal");
    modal.style.display = "none";
  }
  /**
   * select students for a new class changed, reload list
   */


  onSchuelerViewKlasseChanged(_action = null, _senders = null) {
    let instance = this;
    let et2 = this.et2;
    let func = 'schulmanager.schulmanager_ui.ajax_schuelerViewKlasseChanged';
    let klasse_id = 0;

    if (_action !== null) {
      klasse_id = _action.value;
    }

    this.egw.json(func, [klasse_id], function (result) {
      /*
      var sla_nm = <et2_nextmatch>et2.getWidgetById('sla_nm');
      var sko_nm = <et2_nextmatch>et2.getWidgetById('sko_nm');
      sla_nm.applyFilters();
      sko_nm.applyFilters();
      */
      let not_nm = et2.getWidgetById('not_nm');
      not_nm.applyFilters(); // ############### new version
      //instance.tableUpdate("schulmanager-schuelerview_grid-sla", result['sla_nm_rows']);
      //instance.tableUpdate("schulmanager-schuelerview_grid-sko", result['sko_nm_rows']);
      //instance.tableUpdate("schulmanager-schuelerview_grid-san", result['san_nm_rows']);
      // ##############################
      // update schueler select

      let widget = document.getElementById('schulmanager-schuelerview_select_schueler');

      if (widget) {
        let length = widget.options.length;

        for (let i = length - 1; i >= 0; i--) {
          widget.options[i] = null;
        }

        for (let key in result['select_schueler']) {
          let opt = document.createElement("option");
          opt.value = key;
          opt.text = result['select_schueler'][key];
          widget.options.add(opt);
        }
      }

      delete result['select_schueler'];
      instance.schuelerViewUpdate(instance, result);
      /*for (var key in result){
      	if(key == 'details_noten'){
      	}
      	else {
      			var widgetItem = document.getElementById('schulmanager-schuelerview_' + key);
      		if (widgetItem) {
      			widgetItem.innerText = result[key];
      		}
      	}
      }*/
      //egw.loading_prompt('schulmanager',false);
    }).sendRequest(true);
  }
  /**
   * select students for a new class changed, reload list
   */


  onSchuelerViewSchuelerChanged(_action, _senders) {
    let instance = this; //var egw = this.egw;
    //this.egw.loading_prompt('schulmanager',true,egw.lang('please wait...'));

    let et2 = this.et2;
    let func = 'schulmanager.schulmanager_ui.ajax_schuelerViewSchuelerChanged';
    let schueler_id = _action.value;
    this.egw.json(func, [schueler_id], function (result) {
      /*
      var sla_nm = <et2_nextmatch>et2.getWidgetById('sla_nm');
      var sko_nm = <et2_nextmatch>et2.getWidgetById('sko_nm');
      sla_nm.applyFilters('');
      sko_nm.applyFilters('');
      */
      let not_nm = et2.getWidgetById('not_nm');
      not_nm.applyFilters();
      instance.schuelerViewUpdate(instance, result); //egw.loading_prompt('schulmanager',false);
    }).sendRequest(true);
  }
  /**
   * updates nested content
   * @param instance
   * @param result
   */


  schuelerViewUpdate(instance, result) {
    // ############### new version
    instance.tableUpdate("schulmanager-schuelerview_grid-sla", result['sla_nm_rows']);
    instance.tableUpdate("schulmanager-schuelerview_grid-sko", result['sko_nm_rows']);
    instance.tableUpdate("schulmanager-schuelerview_grid-san", result['san_nm_rows']); //instance.tableUpdate("schulmanager-schuelerview_grid-noten", result['noten_nm_rows']);
    // ##############################

    for (let key in result) {
      if (key != 'sla_nm_rows' && key != 'sko_nm_rows' && key != 'san_nm_rows') {
        let widgetItem = document.getElementById('schulmanager-schuelerview_' + key);

        if (widgetItem) {
          widgetItem.innerText = result[key];
        }
      }
    }
  }
  /**
   * appends a new row
   * @param id
   * @param row
   */


  tableUpdate(id, rows) {
    let table = document.getElementById(id); // delete rows

    while (table.rows.length > 1) {
      table.deleteRow(1);
    } // add new rows


    if (table) {
      for (let r = 0; r < rows.length; r++) {
        let newRow = table.insertRow(table.rows.length);
        let rowData = rows[r];

        for (let i = 0; i < rowData.length; i++) {
          let cell = newRow.insertCell(i);
          cell.innerHTML = rowData[i];
        }
      }
    }
  }
  /**
   * Serach accounts to map them to teachers
   */


  onTeacherAutoLinking(_action, _senders) {
    let et2 = this.et2;
    let func = 'schulmanager.schulmanager_substitution_ui.ajax_onTeacherAutoLinking';
    this.egw.json(func, [], function (result) {
      let nm = et2.getWidgetById('nm');
      nm.applyFilters();
    }).sendRequest(true);
  }
  /**
   * Before linking teacher tom egw account
   * @param _action
   * @param _senders
   */


  onTeacherAccountLinkEdit(_action, _senders) {
    let row_id = _senders[0]._index;
    let func = 'schulmanager.schulmanager_substitution_ui.ajax_onTeacherAccountLinkEdit';
    this.egw.json(func, [row_id], function (result) {
      let modal = document.getElementById("schulmanager-accounts_editcontentmodal");
      modal.style.display = "block";
      delete result['link_account_id'];

      for (let key in result) {
        let widget_id = 'schulmanager-accounts_' + key;
        let widget = document.getElementById(widget_id);

        if (widget) {
          widget.innerText = result[key];
        }
      }
    }).sendRequest(true);
  }
  /**
   * Commit teacher-account-link
   * @param _action
   * @param _senders
   */


  onTeacherAccountLinkCommit(_action, _senders) {
    let modal = document.getElementById("schulmanager-accounts_editcontentmodal");
    modal.style.display = "none";
    let et2 = this.et2;
    let selAccount = document.getElementById('schulmanager-accounts_account_id');
    let account = selAccount.value;
    let tokenDiv = document.getElementById('schulmanager-accounts_token');
    let token = tokenDiv.value;
    let func = 'schulmanager.schulmanager_substitution_ui.ajax_onTeacherAccountLinkCommit';
    this.egw.json(func, [account, token], function (result) {
      let nm = et2.getWidgetById('nm');
      nm.refresh(result['row_index'], et2_nextmatch.UPDATE);
    }).sendRequest(true);
  }
  /**
   * Reset single row, delete teacher-account-link
   * @param _action
   * @param _senders
   */


  onTeacherAccountLinkReset(_action, _senders) {
    let et2 = this.et2;
    let row_ids = [];

    for (let i = 0; i < _senders.length; i++) {
      row_ids.push(_senders[i]._index);
    } //var row_id = _senders[0]._index;


    let tokenDiv = document.getElementById('schulmanager-accounts_token');
    let token = tokenDiv.value;
    let func = 'schulmanager.schulmanager_substitution_ui.ajax_onTeacherAccountLinkReset';
    this.egw.json(func, [row_ids, token], function (result) {
      let nm = et2.getWidgetById('nm'); //nm.refresh(result['row_id'], et2_nextmatch.UPDATE);

      nm.applyFilters();
    }).sendRequest(true);
  }

  delLnwPerA() {
    let et2 = this.et2;
    let egw = this.egw;
    let tokenDiv = document.getElementById('schulmanager-schuelerview_token');
    let token = tokenDiv.value;
    et2_dialog.show_dialog(function (button_id, value) {
      if (button_id == et2_dialog.OK_BUTTON) {
        egw.loading_prompt('schulmanager', true, egw.lang('please wait...'));
        let func = 'schulmanager.schulmanager_ui.ajax_delLnwPerA';
        egw.json(func, [token], function (result) {
          let not_nm = et2.getWidgetById('not_nm');
          not_nm.applyFilters();
        }).sendRequest(true);
        egw.loading_prompt('schulmanager', false);
      }
    }, egw.lang('Confirmation required'), egw.lang('Confirmation required'), {}, et2_dialog.BUTTONS_OK_CANCEL, et2_dialog.QUESTION_MESSAGE);
  }

  delLnwPerB() {
    let et2 = this.et2;
    let egw = this.egw;
    let tokenDiv = document.getElementById('schulmanager-schuelerview_token');
    let token = tokenDiv.value;
    et2_dialog.show_dialog(function (button_id, value) {
      if (button_id == et2_dialog.OK_BUTTON) {
        let func = 'schulmanager.schulmanager_ui.ajax_delLnwPerB';
        egw.json(func, [token], function (result) {}).sendRequest(true);
      }

      let not_nm = et2.getWidgetById('not_nm');
      not_nm.applyFilters();
    }, egw.lang('Confirmation required'), egw.lang('Confirmation required'), {}, et2_dialog.BUTTONS_OK_CANCEL, et2_dialog.QUESTION_MESSAGE); //var modal = document.getElementById("schulmanager-notenmanager-notendetails_editcontentmodal");
    //modal.style.display = "none";
  }

  resetAllGrades() {
    let et2 = this.et2;
    let tokenDiv = document.getElementById('schulmanager-mntc_token');
    let token = tokenDiv.value;
    et2_dialog.show_prompt(function (button_id, value) {
      if (button_id == et2_dialog.OK_BUTTON) {
        let func = 'schulmanager.schulmanager_mntc_ui.ajax_resetAllGrades';
        egw.json(func, [token, value], function (result) {
          if (result.error_msg) {
            egw(window).message(result.error_msg, 'error');
          }

          egw(window).message(result.msg, 'success');
        }).sendRequest(true);
      }
    }, egw.lang('Confirmation required'), egw.lang('Absolut sicher, dass alle Noten gelÃ¶scht werden sollen?'), {}, et2_dialog.BUTTONS_OK_CANCEL, et2_dialog.QUESTION_MESSAGE);
  }

}
app.classes.schulmanager = SchulmanagerApp;

export { SchulmanagerApp };
//# sourceMappingURL=app.min.js.map
